<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- Update Content Security Policy to allow necessary resources -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' file:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
    <title>Booklet & MBZ Creator</title>
    <link rel="stylesheet" type="text/css" href="src/assets/styles.css">
    <!-- Add Bootstrap CSS for styling -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <!-- Add Bootstrap Icons CSS -->
    <link rel="stylesheet" href="node_modules/bootstrap-icons/font/bootstrap-icons.css">
    <!-- Add Flatpickr CSS -->
    <link rel="stylesheet" type="text/css" href="node_modules/flatpickr/dist/flatpickr.min.css">
    <!-- Add MBZ Creator specific CSS -->
    <link rel="stylesheet" type="text/css" href="src/assets/mbz_creator.css">
    <!-- Additional custom styles for main view -->
    <style>
        /* Info icon styling */
        .info-icon {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .info-icon:hover {
            opacity: 1;
        }
        
        /* Card styling */
        .card {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.125);
            margin-bottom: 1rem;
        }
        .card-header {
            background-color: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.125);
            padding: 0.5rem 1rem;
        }
        .card-body {
            padding: 0.75rem 1rem;
        }
        
        /* Button improvements */
        .btn {
            border-radius: 4px;
            padding: 0.4rem 0.75rem;
            transition: all 0.2s;
        }
        
        /* App header styling - fixed at top */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.25rem;
            background-color: #ffffff;
            border-bottom: 1px solid #e9ecef;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            height: 60px;
        }
        
        .app-header .app-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin: 0;
            color: #212529;
        }
        
        /* Status bar adjustments - fixed at bottom */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #e9ecef;
            background-color: #f8f9fa;
            padding: 5px 15px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            height: 35px;
        }
        
        /* Add padding to account for fixed header and status bar */
        body {
            padding-top: 70px; /* For fixed header */
            padding-bottom: 40px; /* For fixed status bar */
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* More compact form controls */
        .form-control, .input-group, .btn {
            min-height: unset;
            height: 38px;
        }
        
        /* Directory input form adjustments */
        .directory-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .directory-row:last-child {
            margin-bottom: 0;
        }
        .directory-label {
            width: 60px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            margin-bottom: 1.5em;
        }
        .directory-input {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        
        /* Action buttons grid */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .action-buttons .btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: unset;
            padding: 0.5rem;
        }
        
        /* Utility buttons alignment */
        .utility-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Compact layout for smaller screens */
        @media (max-width: 992px) {
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Bootstrap tooltip custom styling */
        .tooltip {
            font-size: 0.85rem;
        }
        .tooltip-inner {
            max-width: 300px;
            padding: 8px 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Make errors section more compact */
        #errorLogOutput {
            height: 120px;
        }
    </style>
</head>

<body>
    <!-- Single App Header - Content updated by AppSwitcher -->
    <div class="app-header shadow-sm" id="main-header">
        <div class="app-title-container d-flex align-items-center">
            <i class="bi bi-journal-richtext text-primary me-2" style="font-size: 1.25rem;"></i>
            <h1 class="app-title mb-0">Booklet Generation Mode</h1>
        </div>
        <button id="app-mode-switch" class="btn btn-outline-primary app-switcher">
            <i class="bi bi-arrow-repeat me-1"></i>
            Go to Moodle Assignment Creation
        </button>
    </div>

    <!-- Main View (Booklet Generator) -->
    <div id="main-view" class="view-container active">
        <div class="container-fluid px-4">
            <!-- Setup Card (renamed from Directory Configuration) -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h5 class="mb-0 fs-6">
                        <i class="bi bi-folder2-open text-primary me-1"></i>Setup
                    </h5>
                    <a href="#" class="text-decoration-none text-muted small" data-bs-toggle="collapse" data-bs-target="#directoryHelp" aria-expanded="false">
                        <span>What are these directories for?</span>
                        <i class="bi bi-info-circle-fill text-info ms-1"></i>
                    </a>
                </div>
                
                <!-- Collapsible directory help section -->
                <div class="collapse" id="directoryHelp">
                    <div class="card-body bg-light py-2 border-bottom">
                        <p class="mb-1 small"><strong>Input Directory:</strong> Select a folder containing student submissions organized in page-based subdirectories (like 'Seite 1', 'Seite 2'). Each subdirectory should contain student folders with their submissions.</p>
                        <p class="mb-0 small"><strong>Output Directory:</strong> Select or create an empty directory where the processed files and final booklets will be saved. Existing files in this directory may be overwritten.</p>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <!-- Directory inputs (80%) -->
                        <div class="col-md-8">
                            <!-- Input Directory Row -->
                            <div class="directory-row">
                                <div class="directory-label">
                                    <label for="mainDirectoryPath" class="form-label mb-0">
                                        Input
                                    </label>
                                </div>
                                <div class="directory-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="mainDirectoryPath" required>
                                        <button class="btn btn-outline-secondary" type="button" id="select-main-dir-button">
                                            <i class="bi bi-folder2"></i> Browse
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Please select an input directory.</div>
                                </div>
                            </div>
                            
                            <!-- Output Directory Row -->
                            <div class="directory-row">
                                <div class="directory-label">
                                    <label for="outputDirectoryPath" class="form-label mb-0">
                                        Output
                                    </label>
                                </div>
                                <div class="directory-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="outputDirectoryPath" required>
                                        <button class="btn btn-outline-secondary" type="button" id="select-output-dir-button">
                                            <i class="bi bi-folder2"></i> Browse
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Please select an output directory.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Utility buttons column (20%) -->
                        <div class="col-md-3 d-flex flex-column justify-content-center align-items-stretch">
                            <button id="settingsButton" class="btn btn-outline-secondary mb-2">
                                <i class="bi bi-gear me-1"></i> Settings
                            </button>
                            <button id="editCoverTemplateBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-text me-1"></i> Edit Cover Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Actions Card -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h5 class="mb-0 fs-6">
                        <i class="bi bi-gear-fill text-primary me-1"></i>Processing Actions
                    </h5>
                    <a href="#" class="text-decoration-none text-muted small" data-bs-toggle="collapse" data-bs-target="#processingHelp" aria-expanded="false">
                        <span>How does this work?</span>
                        <i class="bi bi-info-circle-fill text-info ms-1"></i>
                    </a>
                </div>
                
                <!-- Collapsible processing help section -->
                <div class="collapse" id="processingHelp">
                    <div class="card-body bg-light py-2 border-bottom">
                        <p class="mb-2 small">Follow these steps in sequence to create booklets:</p>
                        <ol class="mb-0 ps-3 small">
                            <li><strong>Clear Output Folder:</strong> Removes all files from the output directory. Use with caution!</li>
                            <li><strong>Convert Inputs to PDFs:</strong> Converts all image files (PNG, JPG, etc.) to PDF format.</li>
                            <li><strong>Merge PDFs:</strong> Combines all PDFs for each student based on the page structure.</li>
                            <li><strong>Create Booklets:</strong> Creates final booklets with cover pages and appropriate metadata.</li>
                        </ol>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Main Action Buttons in Grid -->
                    <div class="action-buttons">
                        <button id="clearOutputBtn" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-1"></i> 0. Clear Output
                        </button>
                        <button id="startTransformationBtn" class="btn btn-primary">
                            <i class="bi bi-image me-1"></i> 1. Convert to PDFs
                        </button>
                        <button id="startMergingBtn" class="btn btn-primary">
                            <i class="bi bi-file-earmark-pdf me-1"></i> 2. Merge PDFs
                        </button>
                        <button id="createBookletsBtn" class="btn btn-primary">
                            <i class="bi bi-journal-check me-1"></i> 3. Create Booklets
                        </button>
                    </div>
                </div>
            </div>
        
            <!-- Error Log Card -->
            <div id="errorLogContainer" style="display: none;">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h5 class="mb-0 fs-6"><i class="bi bi-exclamation-triangle me-2"></i>Processing Errors & Warnings</h5>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="errorLogOutput" readonly 
                            class="form-control border-0 bg-light font-monospace" 
                            style="resize: vertical; font-size: 0.85rem;"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MBZ Creator View - Content loaded dynamically -->
    <div id="mbz-creator-view" class="view-container">
        <p>Loading Moodle Batch Creator...</p>
    </div>

    <!-- Status Bar - Placed outside view containers to be persistent -->
    <div id="status-bar">
        <span id="progress-count" class="status-part"></span>
        <span id="progress-percent" class="status-part"></span>
        <span id="status-message" class="status-part status-message-main">Ready</span>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal settings-modal-wide">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Settings</h2>
            
            <!-- DPI Setting -->
            <div class="form-group settings-group">
                <label for="dpi" class="block-label">DPI:</label>
                <input type="number" id="dpi" value="300" class="form-control full-width">
                <small>Resolution for converting images. Higher values = better quality but larger files. 300 is standard for printing.</small>
            </div>

            <!-- Folder Pattern Setting -->
            <div class="form-group settings-group">
                <label for="foldername-pattern" class="block-label">Folder Name Pattern:</label>
                
                <!-- Pattern Presets -->
                <div class="pattern-presets">
                    <div class="preset-option">
                        <input type="radio" id="pattern-ilias" name="pattern-preset" value="FIRSTNAME_LASTNAME_USERNAME_STUDENTNUMBER">
                        <label for="pattern-ilias">Ilias Format</label>
                    </div>
                    <div class="preset-option">
                        <input type="radio" id="pattern-moodle" name="pattern-preset" value="FULLNAMEWITHSPACES_SOMENUMBER_assignsubmission_file_">
                        <label for="pattern-moodle">Moodle Format (Enables CSV Collision Handling)</label>
                    </div>
                    <div class="preset-option">
                        <input type="radio" id="pattern-custom" name="pattern-preset" value="custom" checked>
                        <label for="pattern-custom">Custom Format</label>
                    </div>
                </div>
                
                <!-- Pattern Input -->
                <input type="text" id="foldername-pattern" class="form-control full-width" placeholder="e.g., FIRSTNAME-LASTNAME or FULLNAMEWITHSPACES_NUMBER_assignsubmission_file_">
                
                <!-- Compact Pattern Help -->
                <div class="pattern-help">
                    <details>
                        <summary><strong>Pattern Help</strong> (click to expand)</summary>
                        <div class="pattern-explanation compact">
                            <p>Define how student folders are named. Use separator character from your folders (<code>_</code> or <code>-</code>).</p>
                            <p><small><strong>Note:</strong> Selecting 'Moodle Format' also enables automatic name collision handling if you place the corresponding Moodle Grading Worksheet CSV file inside each page's input subfolder (e.g., `Seite 1/worksheet.csv`). You will be prompted if collisions are detected.</small></p>
                            <div class="two-columns">
                                <div>
                                    <strong>Available Placeholders:</strong>
                                    <ul class="compact-list">
                                        <li><code>FIRSTNAME</code></li>
                                        <li><code>LASTNAME</code></li>
                                        <li><code>FULLNAMEWITHSPACES</code></li>
                                        <li><code>USERNAME</code></li>
                                        <li><code>STUDENTNUMBER</code> (preferred identifier)</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>Examples:</strong>
                                    <ul class="compact-list">
                                        <li>Ilias: <code>FIRSTNAME_LASTNAME_USERNAME_STUDENTNUMBER</code></li>
                                        <li>Moodle: <code>FULLNAMEWITHSPACES_SOMENUMBER_assignsubmission_file_</code></li>
                                        <li>Simple: <code>LASTNAME-FIRSTNAME</code></li>
                                    </ul>
                                </div>
                            </div>
                            <p><small><strong>Identifier Priority:</strong> Student Number > Username > Full Name > Original Folder Name</small></p>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Filesize Limits -->
            <div class="form-group settings-group">
                <label class="block-label">Input File Size Limits:</label>
                <div class="inline-inputs">
                    <div>
                        <label for="minFileSizeKB">Min (KB):</label>
                        <input type="number" id="minFileSizeKB" value="1" min="0" class="form-control short-input">
                    </div>
                    <div>
                        <label for="maxFileSizeMB">Max (MB):</label>
                        <input type="number" id="maxFileSizeMB" value="20" min="1" class="form-control short-input">
                    </div>
                </div>
                <small>Minimum and maximum allowed size for each input file (images/PDFs). Files outside this range will be skipped.</small>
            </div>

            <hr>

            <!-- Config Actions -->
            <div class="button-group settings-actions">
                 <button id="exportConfigBtn" class="btn btn-secondary">Export Config</button>
                 <button id="importConfigBtn" class="btn btn-secondary">Import Config</button>
            </div>
        </div>
    </div>
    
    <div id="moodleCollisionModal" class="modal collision-modal-wide">
        <div class="modal-content">
            <span class="close-button moodle-collision-close">&times;</span>
            <h2>Potential Issues Detected (Moodle Pattern)</h2>
            <!-- CSV Status Section -->
            <div id="csvStatusInfo" class="csv-status-info">
                <!-- Status message populated by JS -->
            </div>

            <!-- Missing CSV Mappings Section (NEW) -->
            <div id="mappingErrorSection" class="collision-section" style="display: none;"> <!-- Hidden by default -->
                <h3><span class="warning-icon">⚠️</span> Missing CSV Mappings</h3>
                <p><small>The following students (identified by the number in their folder name) could not be found in the CSV file located in their respective page folder. This often means the wrong CSV file was placed in that folder.</small></p>
                <ul id="mappingErrorList">
                    <!-- List of mapping errors will be populated here -->
                </ul>
                <p><strong>Action required:</strong> Please ensure the correct CSV file (containing these students) is placed in each listed page folder.</p>
            </div>

            <!-- Existing Same-Name Collisions Section -->
            <div id="collisionNameSection" class="collision-section" style="display: none;"> <!-- Hidden by default -->
                <h3><span class="warning-icon">⚠️</span> Same-Name Collisions</h3>
                <p><small>These student identifiers (name or email) have multiple different submission folders associated with them within the same page folder, AND this could not be resolved automatically using emails from CSV files.</small></p>
                <ul id="collisionList">
                    <!-- List of colliding names will be populated here -->
                </ul>
            </div>

            <!-- Resolution Options -->
            <p><strong>Please resolve the issues listed above using one of the following methods before continuing:</strong></p>
            <ol style="font-size: 0.95em;">
                <li>
                    <strong>Using CSV Files (Recommended):</strong> Place the Moodle Grading Worksheet CSV file inside <em>each</em> page subfolder within your input directory (e.g., put the 'Seite 1.csv' inside the 'Seite 1' folder). 
                    <ul>
                        <li>CSV files must be present in <em>all</em> page folders where students with identical names appear</li>
                        <li>Each CSV must contain both an 'ID' column (corresponding to the number in the place of SOMENUMBER in the folder name template) and an 'E-Mail-Adresse' column (rename columns if necessary)</li>
                        <li>The tool uses the email addresses from the CSV files and the IDs to uniquely identify students even when names are identical</li>
                    </ul>
                </li>
                <li>
                    <strong>Manual Folder Renaming:</strong> If CSV files are unavailable, you must manually rename the student submission folders as follows:
                    <ul>
                        <li>Folders for the <em>same student</em> must have <em>exactly the same name</em> across all page directories</li>
                        <li>Folders for <em>different students</em> must have different names</li>
                        <li>You must rename <em>all</em> folders for students with same names in <em>all</em> page directories in a consistent manner, even where only one of the students submitted a particular page</li>
                        <li>Example: If there are two 'Anna Schmidt' in 'Seite 1' and 'Seite 2', change the name (e.g. Anna1) in one of these same-named subfolders in each of these directories identically</li>
                    </ul>
                </li>
            </ol>
            <div style="text-align: right; margin-top: 20px;">
                <button id="moodleCollisionRetryWithCSVBtn" class="btn btn-primary">Check Again After Changes</button>
                <button id="moodleCollisionOkBtn">Close</button>
            </div>
        </div>
    </div>
    
    <div id="ambiguityModal" class="modal">
        <div class="modal-content ambiguity-modal-content">
            <span class="close-button ambiguity-close">&times;</span>
            <h2>Resolve File Conflicts</h2>
            <p>Multiple suitable files found. Please select one file for each folder:</p>
            <div id="ambiguityProgress" style="margin-bottom: 15px; font-style: italic;"></div>
            <div id="ambiguityList"></div> 
            <div class="ambiguity-navigation" style="margin-top: 20px; display: flex; justify-content: space-between;">
                <button id="ambiguityPrevBtn" disabled>&laquo; Previous</button>
                <button id="ambiguityNextBtn">Next &raquo;</button>
                <button id="confirmAmbiguityBtn" style="display: none;">Confirm Selections</button> <!-- Initially hidden -->
            </div>
            <div id="ambiguityError" class="error-message"></div>
        </div>
    </div>
    
    <div id="coverTemplateModal" class="modal cover-template-modal">
        <div class="modal-content">
            <span class="close-button cover-template-close">&times;</span>
            <h2>Edit Cover Template</h2>
            
            <div class="form-group">
                <label for="coverTemplateContentInput" class="block-label">Template Content (Markdown):</label>
                <textarea id="coverTemplateContentInput" class="form-control full-width" rows="15"></textarea>
            </div>
            
            <!-- Template Help -->
            <div class="pattern-help" style="margin-top: 15px;">
                <details>
                    <summary><strong>Template Help</strong> (click to expand)</summary>
                    <div class="pattern-explanation compact" style="font-size: 0.9em;">
                        <p>Use Markdown to format the cover page. The following placeholders will be replaced:</p>
                        <ul class="compact-list">
                            <li><code>{{FULL_NAME}}</code>: Student's full name (derived from folder name based on pattern).</li>
                            <li><code>{{LAST_NAME}}</code>: Student's last name.</li>
                            <li><code>{{FIRST_NAME}}</code>: Student's first name.</li>
                            <li><code>{{STUDENTNUMBER}}</code>: Student's number (if available in folder name and pattern).</li>
                            <li><code>{{SUBMITTED_PAGES_LIST}}</code>: A list of submitted pages and original filenames.</li>
                            <li><code>{{MISSING_PAGES_LIST}}</code>: A list of expected page directories not found for the student.</li>
                        </ul>
                        <p>Example:</p>
                        <pre><code># Exam Submission

**Student:** {{LAST_NAME}}, {{FIRST_NAME}}
**Number:** {{STUDENTNUMBER}}

## Submitted Pages:
{{SUBMITTED_PAGES_LIST}}

## Missing Pages:
{{MISSING_PAGES_LIST}}</code></pre>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Script Includes -->
    <script src="src/js/renderer.js"></script>
    <script src="node_modules/flatpickr/dist/flatpickr.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="src/assets/vertical-calendar.js"></script>
    <script src="src/assets/vertical-calendar-controller.js"></script>
    <script src="src/assets/calendar-fix.js"></script>
    <script src="src/assets/app-switcher.js"></script>
    <script src="src/assets/batch-creator.js"></script>

    <!-- Initialization Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize tooltips and popovers
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize AppSwitcher
            window.appSwitcher = new AppSwitcher({
                mainViewSelector: '#main-view',
                mbzViewSelector: '#mbz-creator-view',
                switchButtonSelector: '#app-mode-switch', 
                titleElementSelector: '#main-header .app-title', // Target title within main header
                mainViewTitle: 'Booklet Generation Mode',
                mbzViewTitle: 'Moodle Batch Assignment Creation Mode'
            });

            let mbzCreatorInstance = null;
            let calendarControllerInstance = null;

            // Initialize MBZ creator only when its view becomes active
            window.addEventListener('viewChanged', async (event) => {
                if (event.detail.view === 'mbz' && !mbzCreatorInstance) {
                    const mbzContainer = document.getElementById('mbz-creator-view');
                    if (mbzContainer) {
                        mbzCreatorInstance = MbzBatchCreator.initialize(mbzContainer); // initialize returns the instance
                        // The buildUI method is now async, wait for it if necessary
                        await mbzCreatorInstance.buildUI(); 
                        // Re-find elements and attach listeners *after* UI is built
                        mbzCreatorInstance.findElements(); 
                        mbzCreatorInstance.setupCollapse(); // Setup collapse after elements are found
                        mbzCreatorInstance.initCalendar();
                        mbzCreatorInstance.attachEventListeners();
                        mbzCreatorInstance.updateGenerateButtonState();
                        
                        // Initialize calendar controller after MBZ UI and calendar are ready
                        setTimeout(() => { 
                            if (mbzCreatorInstance.calendar) {
                                // Pass the mbzCreatorInstance to the controller's initialize method
                                calendarControllerInstance = VerticalCalendarController.initialize(
                                    mbzCreatorInstance.calendar, 
                                    mbzCreatorInstance 
                                );
                                // Link the controller with the batch creator (optional if not used elsewhere)
                                mbzCreatorInstance.setController(calendarControllerInstance);
                            }
                        }, 100); // Short delay might be needed for calendar rendering
                    }
                }
            });

            // Handle initial view based on hash
            if (window.location.hash === '#mbz') {
                window.appSwitcher.showMbzView();
            }
            
            // Initialize modal functionality (if modal.js is removed)
            function initializeModals() {
                 const modals = document.querySelectorAll('.modal');
                 modals.forEach(modal => {
                     const closeButton = modal.querySelector('.close-button');
                     if (closeButton) {
                         closeButton.onclick = () => modal.style.display = 'none';
                     }
                     // Close on outside click
                     window.addEventListener('click', (event) => {
                         if (event.target === modal) {
                             modal.style.display = 'none';
                         }
                     });
                 });
                 
                 // Specific modal triggers
                 const settingsBtn = document.getElementById('settingsButton');
                 if (settingsBtn) settingsBtn.onclick = () => document.getElementById('settingsModal').style.display = 'block';
                 
                 const coverBtn = document.getElementById('editCoverTemplateBtn');
                 if (coverBtn) coverBtn.onclick = () => document.getElementById('coverTemplateModal').style.display = 'block';
                 
                 // Save config when settings/cover modals close
                 const settingsModal = document.getElementById('settingsModal');
                 const coverModal = document.getElementById('coverTemplateModal');
                 if(settingsModal) settingsModal.querySelector('.close-button').addEventListener('click', window.saveConfig || (() => console.warn('saveConfig not found')));
                 if(coverModal) coverModal.querySelector('.close-button').addEventListener('click', window.saveConfig || (() => console.warn('saveConfig not found')));
                 window.addEventListener('click', (event) => {
                     if(settingsModal && event.target === settingsModal) window.saveConfig();
                     if(coverModal && event.target === coverModal) window.saveConfig();
                 });
                 
                 // Ensure ambiguity/collision modal logic still works without modal.js
                 const ambiguityModal = document.getElementById('ambiguityModal');
                 const ambiguityCloseBtn = ambiguityModal?.querySelector('.ambiguity-close');
                 if(ambiguityCloseBtn) ambiguityCloseBtn.onclick = () => ambiguityModal.style.display = 'none';
                 
                 const moodleCollisionModal = document.getElementById('moodleCollisionModal');
                 const moodleCollisionCloseBtn = moodleCollisionModal?.querySelector('.moodle-collision-close');
                 if(moodleCollisionCloseBtn) moodleCollisionCloseBtn.onclick = () => moodleCollisionModal.style.display = 'none';
                 const moodleCollisionOkBtn = document.getElementById('moodleCollisionOkBtn');
                 if(moodleCollisionOkBtn) moodleCollisionOkBtn.onclick = () => moodleCollisionModal.style.display = 'none';
                 
            }
            initializeModals();
        });
    </script>

</body>
</html>