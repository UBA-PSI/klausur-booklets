<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- Update Content Security Policy to allow necessary resources -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' file:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
    <title>Exam Booklet Tool</title>
    <link rel="stylesheet" type="text/css" href="src/assets/styles.css">
    <!-- Add Bootstrap CSS for styling -->
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <!-- Add Bootstrap Icons CSS -->
    <link rel="stylesheet" href="node_modules/bootstrap-icons/font/bootstrap-icons.css">
    <!-- Add Flatpickr CSS -->
    <link rel="stylesheet" type="text/css" href="node_modules/flatpickr/dist/flatpickr.min.css">
    <!-- Add MBZ Creator specific CSS -->
    <link rel="stylesheet" type="text/css" href="src/assets/mbz_creator.css">
    <!-- Additional custom styles for main view -->
    <style>
        /* Info icon styling */
        .info-icon {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .info-icon:hover {
            opacity: 1;
        }
        
        /* Card styling */
        .card {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.125);
            margin-bottom: 1rem;
        }
        .card-header {
            background-color: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.125);
            padding: 0.5rem 1rem;
        }
        .card-body {
            padding: 0.75rem 1rem;
        }
        
        /* Button improvements */
        .btn {
            border-radius: 4px;
            padding: 0.4rem 0.75rem;
            transition: all 0.2s;
        }
        
        /* App header styling - fixed at top */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.25rem;
            background-color: #ffffff;
            border-bottom: 1px solid #e9ecef;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            height: 60px;
        }
        
        .app-header .app-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin: 0;
            color: #212529;
        }
        
        /* Status bar adjustments - fixed at bottom */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #e9ecef;
            background-color: #f8f9fa;
            padding: 5px 15px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            height: 35px;
        }
        
        /* Add padding to account for fixed header and status bar */
        body {
            padding-top: 70px; /* For fixed header */
            padding-bottom: 40px; /* For fixed status bar */
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* More compact form controls */
        .form-control, .input-group, .btn {
            min-height: unset;
            height: 38px;
        }
        
        /* Directory input form adjustments */
        .directory-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .directory-row:last-child {
            margin-bottom: 0;
        }
        .directory-label {
            width: 60px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            margin-bottom: 1.5em;
        }
        .directory-input {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        
        /* Action buttons grid */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .action-buttons .btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: unset;
            padding: 0.5rem;
        }
        
        /* Utility buttons alignment */
        .utility-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Compact layout for smaller screens */
        @media (max-width: 992px) {
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Bootstrap tooltip custom styling */
        .tooltip {
            font-size: 0.85rem;
        }
        .tooltip-inner {
            max-width: 300px;
            padding: 8px 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Make errors section more compact */
        #errorLogOutput {
            height: 120px;
        }
    </style>
</head>

<body>
    <!-- Single App Header - Content updated by AppSwitcher -->
    <div class="app-header shadow-sm" id="main-header">
        <div class="app-title-container d-flex align-items-center">
            <i class="bi bi-journal-richtext text-primary me-2" style="font-size: 1.25rem;"></i>
            <h1 class="app-title mb-0">Booklet Generation Mode</h1>
        </div>
        <button id="app-mode-switch" class="btn btn-outline-primary app-switcher">
            <i class="bi bi-arrow-repeat me-1"></i>
            Go to Moodle Assignment Creation
        </button>
    </div>

    <!-- Main View (Booklet Generator) -->
    <div id="main-view" class="view-container active">
        <div class="container-fluid px-4">
            <!-- Setup Card (renamed from Directory Configuration) -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h5 class="mb-0 fs-6">
                        <i class="bi bi-folder2-open text-primary me-1"></i>Setup
                    </h5>
                    <a href="#" class="text-decoration-none text-muted small" data-bs-toggle="collapse" data-bs-target="#directoryHelp" aria-expanded="false">
                        <span>What are these directories for?</span>
                        <i class="bi bi-info-circle-fill text-info ms-1"></i>
                    </a>
                </div>
                
                <!-- Collapsible directory help section -->
                <div class="collapse" id="directoryHelp">
                    <div class="card-body bg-light py-2 border-bottom">
                        <p class="mb-1 small"><strong>Input Directory:</strong> Select the folder containing student submissions organized in page-based subdirectories (like 'Page 1', 'Page 2'). Each subdirectory should contain student folders with their submissions. Go to Settings to specify how the folders are named. For University of Bamberg, the Moodle naming scheme should already match the one that is shown in the settings.</p>
                        <p class="mb-0 small"><strong>Output Directory:</strong> Create an empty directory where the processed files and final booklets will be saved. Existing files in this directory may be overwritten. Empty the directory before starting a new booklet generation to avoid confusion and errors.</p>
                        <p class="mb-0 small"><strong>Settings:</strong> Here, you can specify the DPI for the output images, the folder name pattern, and the minimum and maximum file size for the input files.</p>
                        <p class="mb-0 small"><strong>Edit Cover Template:</strong> Here, you can edit the cover template for the booklet. There is a default template that shows the name of the student and the list of submitted and missing pages.</p>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <!-- Directory inputs (80%) -->
                        <div class="col-md-8">
                            <!-- Input Directory Row -->
                            <div class="directory-row">
                                <div class="directory-label">
                                    <label for="mainDirectoryPath" class="form-label mb-0">
                                        Input
                                    </label>
                                </div>
                                <div class="directory-input">
        <div class="input-group">
                                        <input type="text" class="form-control" id="mainDirectoryPath" required>
                                        <button class="btn btn-outline-secondary" type="button" id="select-main-dir-button">
                                            <i class="bi bi-folder2"></i> Browse
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Please provide the input directory.</div>
                                </div>
        </div>

                            <!-- Output Directory Row -->
                            <div class="directory-row">
                                <div class="directory-label">
                                    <label for="outputDirectoryPath" class="form-label mb-0">
                                        Output
                                    </label>
                                </div>
                                <div class="directory-input">
        <div class="input-group">
                                        <input type="text" class="form-control" id="outputDirectoryPath" required>
                                        <button class="btn btn-outline-secondary" type="button" id="select-output-dir-button">
                                            <i class="bi bi-folder2"></i> Browse
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Please provide an output directory.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Utility buttons column (20%) -->
                        <div class="col-md-3 d-flex flex-column justify-content-center align-items-stretch">
                            <button id="settingsButton" class="btn btn-outline-secondary mb-2">
                                <i class="bi bi-gear me-1"></i> Settings
                            </button>
                            <button id="editCoverTemplateBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-text me-1"></i> Edit Cover Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Actions Card -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h5 class="mb-0 fs-6">
                        <i class="bi bi-gear-fill text-primary me-1"></i>Processing Actions
                    </h5>
                    <a href="#" class="text-decoration-none text-muted small" data-bs-toggle="collapse" data-bs-target="#processingHelp" aria-expanded="false">
                        <span>How does this work?</span>
                        <i class="bi bi-info-circle-fill text-info ms-1"></i>
                    </a>
        </div>

                <!-- Collapsible processing help section -->
                <div class="collapse" id="processingHelp">
                    <div class="card-body bg-light py-2 border-bottom">
                        <p class="mb-2 small">Follow these steps in sequence to create booklets:</p>
                        <ol class="mb-0 ps-3 small">
                            <li><strong>Clear Output Folder:</strong> Removes all files from the output directory to avoid confusion and errors. Use with caution!</li>
                            <li><strong>Convert Inputs to PDFs:</strong> Converts all image files (PNG, JPG, PDF.) to PDFs with rasterized images. This first step is necessary to avoid errors when merging the PDFs and to ensure that the final booklets are of uniform quality. Images in landscape orientation are automatically rotated to portrait orientation to maximize the use of the page space. Images are also resized to fill a whole page. PDFs are rasterized at the DPI specified in the settings to avoid any issues with vector graphics and fonts. If more than one image is present in a page folder, you will be prompted to select which one to use. If a PDF is present that contains more than one page, only the first page will be used. If a page contains submissions from multiple students with the same name and this cannot be resolved automatically, you will be prompted to resolve this manually by renaming the folders or, in case of Moodle, providing Moodle Grading Worksheet CSV files.</li>
                            <li><strong>Merge PDFs:</strong> Combines all single-page PDFs for each student based into a single PDF per student (subdirectory pdfs in the output directory), including the cover page. These PDFs are useful for previewing the final booklets.</li>
                            <li><strong>Create Booklets:</strong> Creates final booklets where two A5 pages are placed next to each otherinto a single A4 page. The pages are ordered so that you can print the resulting A4 pages on a duplex printer (short-edge binding) and stapled in the middle.</li>
                        </ol>
                    </div>
                </div>
                
                <div class="card-body pt-4">
                    <!-- Main Action Buttons in Grid -->
                    <div class="action-buttons">
                        <button id="clearOutputBtn" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-1"></i> 1. Clear Output
                        </button>
                        <button id="startTransformationBtn" class="btn btn-primary">
                            <i class="bi bi-image me-1"></i> 2. Convert to PDFs
                        </button>
                        <button id="startMergingBtn" class="btn btn-primary">
                            <i class="bi bi-file-earmark-pdf me-1"></i> 3. Merge PDFs
                        </button>
                        <button id="createBookletsBtn" class="btn btn-primary">
                            <i class="bi bi-journal-check me-1"></i> 4. Create Booklets
                        </button>
                    </div>
		</div>
        </div>

            <!-- NEW Process Log Card -->
            <div id="processLogContainer" style="display: none;">
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-dark py-2">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 fs-6"><i class="bi bi-terminal me-2"></i>Process Log</h5>
                            <button class="btn btn-sm btn-outline-secondary ms-2 border-0" 
                                    id="copyProcessLogBtn" title="Copy Log" 
                                    style="padding: 0.1rem 0.4rem; line-height: 1; background: none;">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="processLogOutput" readonly 
                            class="form-control border-0 bg-light font-monospace" 
                            style="height: 150px; resize: vertical; font-size: 0.85rem;"></textarea>
                    </div>
                </div>
            </div>

            <!-- Error Log Card -->
            <div id="errorLogContainer" style="display: none;">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h5 class="mb-0 fs-6"><i class="bi bi-exclamation-triangle me-2"></i>Processing Errors & Warnings</h5>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="errorLogOutput" readonly 
                            class="form-control border-0 bg-light font-monospace" 
                            style="resize: vertical; font-size: 0.85rem;"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MBZ Creator View - Content loaded dynamically -->
    <div id="mbz-creator-view" class="view-container">
        <p>Loading Moodle Batch Creator...</p>
    </div>

    <!-- Status Bar - Placed outside view containers to be persistent -->
		<div id="status-bar">
            <span id="progress-count" class="status-part"></span>
            <span id="progress-percent" class="status-part"></span>
            <span id="status-message" class="status-part status-message-main">Ready</span>
		</div>
    <!-- Modals -->
    <div id="settingsModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content p-0">
                <div class="modal-header bg-light border-bottom d-flex justify-content-between align-items-center p-3">
                    <h5 class="modal-title mb-0">
                        <i class="bi bi-gear-fill text-primary me-2"></i>Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
		
                <div class="modal-body p-3">

                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-image text-primary me-1"></i>Resolution for Rasterizing Submitted PDFs
                            </h6>
                        </div>
                        <div class="card-body py-0">
                            <div class="d-flex align-items-center mt-4">
                                <div class="input-group" style="max-width: 180px;">
                                    <input type="number" id="dpi" value="300" class="form-control">
                                    <span class="input-group-text">dpi</span>
                                </div>
                                <span class="text-muted ms-3 align-middle" style="margin-bottom: 1.5em;">Higher values:
                                    better quality but larger files. 300 dpi is often sufficient.</span>
                            </div>
                        </div>
    </div>
	
                    <!-- Folder Pattern Setting Card -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-folder2 text-primary me-1"></i>Folder Name Pattern
                            </h6>
        </div>
                        <div class="card-body py-2">
                            <p class="small">This pattern is used when reading the student submission folders in the input
                                directory. The default pattern is the Moodle format, which is the format used by the
                                University of Bamberg. If you are using Moodle, you can select the Moodle format, which will
                                enable automatic name collision handling. The Ilias format is the format used by the Ilias
                                LMS and contains a Student Number field, which is also supported and will avoid name
                                collisions. The custom format allows you to enter a custom pattern.</p>
            
            <!-- Pattern Presets -->
                            <div class="pattern-presets mb-2 d-flex justify-content-between">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="pattern-ilias" name="pattern-preset"
                                        value="FIRSTNAME_LASTNAME_USERNAME_STUDENTNUMBER">
                                    <label class="form-check-label" for="pattern-ilias">Ilias Format</label>
                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="pattern-moodle" name="pattern-preset"
                                        value="FULLNAMEWITHSPACES_SOMENUMBER_assignsubmission_file_">
                                    <label class="form-check-label" for="pattern-moodle">Moodle Format</label>
                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="pattern-custom" name="pattern-preset"
                                        value="custom" checked>
                                    <label class="form-check-label" for="pattern-custom">Custom Format</label>
                </div>
            </div>
            
            <!-- Pattern Input -->
                            <div class="mb-3">
                                <input type="text" id="foldername-pattern" class="form-control"
                                    placeholder="e.g., FIRSTNAME-LASTNAME or FULLNAMEWITHSPACES_NUMBER_assignsubmission_file_">
                            </div>
            
            <!-- Compact Pattern Help -->
                            <div class="pattern-help mb-0">
                                <button class="btn btn-outline-secondary btn-sm w-100" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#patternHelpCollapse">
                                    <i class="bi bi-info-circle me-1"></i>Pattern Help
                                </button>
                                <div class="collapse mt-2" id="patternHelpCollapse">
                                    <div class="card card-body bg-light py-2 small">
                                        <p class="mb-2">Define how student folders are named. Use separator character from
                                            your folders (<code>_</code> or <code>-</code>).</p>
                                        <p class="mb-2"><strong>Note:</strong> Selecting 'Moodle Format' enables
                                            semi-automatic name collision handling if you place the corresponding Moodle
                                            Grading Worksheet CSV file inside each page's input subfolder (e.g., `Page
                                            1/worksheet.csv`). You will be prompted if collisions are detected and the CSV
                                            files are required.</p>

                                        <div class="row">
                                            <div class="col-md-6">
                                <strong>Available Placeholders:</strong>
                                                <ul class="ps-3 mb-2">
                                                    <li><code>FIRSTNAME</code> (only if firstname(s) and lastname(s) are
                                                        clearly separated in the input directory, not the case with Moodle)
                                                    </li>
                                                    <li><code>LASTNAME</code> (only if firstname(s) and lastname(s) are
                                                        clearly separated in the input directory, not the case with Moodle)
                                                    </li>
                                                    <li><code>FULLNAMEWITHSPACES</code> (typically used with Moodle)</li>
                                                    <li><code>USERNAME</code> (used with Ilias)</li>
                                                    <li><code>STUDENTNUMBER</code> (used with Ilias, preferred identifier)
                                                    </li>
                                </ul>
                            </div>
                                            <div class="col-md-6">
                                <strong>Examples:</strong>
                                                <ul class="ps-3 mb-2">
                                    <li>Ilias: <code>FIRSTNAME_LASTNAME_USERNAME_STUDENTNUMBER</code></li>
                                                    <li>Moodle:
                                                        <code>FULLNAMEWITHSPACES_SOMENUMBER_assignsubmission_file_</code>
                                                    </li>
                                    <li>Simple: <code>LASTNAME-FIRSTNAME</code></li>
                                </ul>
                                            </div>
                                        </div>

                                        <p class="mb-0"><strong>Identifier Priority:</strong> Student Number > Username >
                                            Full Name > Original Folder Name</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filesize Limits Card -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <h6 class="mb-0">
                                <i class="bi bi-file-earmark-ruled text-primary me-1"></i>File Size Limits
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <p class="small">Acceptable sizes of images/PDFs. Files outside this range will be skipped.</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label for="minFileSizeKB" class="form-label">Minimum Size (KB):</label>
                                        <input type="number" id="minFileSizeKB" value="1" min="0" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <label for="maxFileSizeMB" class="form-label">Maximum Size (MB):</label>
                                        <input type="number" id="maxFileSizeMB" value="20" min="1" class="form-control">
                                    </div>
                                </div>
                            </div>
            </div>
        </div>
                </div>

                <div class="modal-footer bg-light border-top d-flex justify-content-between p-3">
                <div>
                        <button id="importConfigBtn" class="btn btn-outline-secondary">
                            <i class="bi bi-upload me-1"></i>Import Config
                        </button>
                        <button id="exportConfigBtn" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-download me-1"></i>Export Config
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="moodleCollisionModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
    <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Potential Issues Detected (Moodle Pattern)</h5>
                <button type="button" class="btn-close moodle-collision-close" aria-label="Close"></button>
            </div>
            <div class="modal-body">
        <!-- CSV Status Section -->
        <div id="csvStatusInfo" class="csv-status-info">
            <!-- Status message populated by JS -->
        </div>

        <!-- Missing CSV Mappings Section (NEW) -->
        <div id="mappingErrorSection" class="collision-section" style="display: none;"> <!-- Hidden by default -->
            <h3><span class="warning-icon">⚠️</span> Missing CSV Mappings</h3>
            <p><small>The following students (identified by the number in their folder name) could not be found in the CSV file located in their respective page folder. This often means the wrong CSV file was placed in that folder.</small></p>
            <ul id="mappingErrorList">
                <!-- List of mapping errors will be populated here -->
            </ul>
            <p><strong>Action required:</strong> Please ensure the correct CSV file (containing these students) is placed in each listed page folder.</p>
        </div>

        <!-- Existing Same-Name Collisions Section -->
        <div id="collisionNameSection" class="collision-section" style="display: none;"> <!-- Hidden by default -->
            <h3><span class="warning-icon">⚠️</span> Same-Name Collisions</h3>
            <p><small>These student identifiers (name or email) have multiple different submission folders associated with them within the same page folder, AND this could not be resolved automatically using emails from CSV files.</small></p>
            <ul id="collisionList">
                <!-- List of colliding names will be populated here -->
            </ul>
        </div>

        <!-- Resolution Options -->
        <p><strong>Please resolve the issues listed above using one of the following methods before continuing:</strong></p>
        <ol style="font-size: 0.95em;">
            <li>
                            <strong>Using CSV Files (Recommended):</strong> Place the Moodle Grading Worksheet CSV file inside <em>each</em> page subfolder within your input directory (e.g., put the 'Page 1.csv' inside the 'Page 1' folder). 
                <ul>
                    <li>CSV files must be present in <em>all</em> page folders where students with identical names appear</li>
                    <li>Each CSV must contain both an 'ID' column (corresponding to the number in the place of SOMENUMBER in the folder name template) and an 'E-Mail-Adresse' column (rename columns if necessary)</li>
                    <li>The tool uses the email addresses from the CSV files and the IDs to uniquely identify students even when names are identical</li>
                </ul>
            </li>
            <li>
                <strong>Manual Folder Renaming:</strong> If CSV files are unavailable, you must manually rename the student submission folders as follows:
                <ul>
                    <li>Folders for the <em>same student</em> must have <em>exactly the same name</em> across all page directories</li>
                    <li>Folders for <em>different students</em> must have different names</li>
                    <li>You must rename <em>all</em> folders for students with same names in <em>all</em> page directories in a consistent manner, even where only one of the students submitted a particular page</li>
                                <li>Example: If there are two 'Anna Schmidt' in 'Page 1' and 'Page 2', change the name (e.g. Anna1) in one of these same-named subfolders in each of these directories identically</li>
                </ul>
            </li>
        </ol>
            </div>
            <div class="modal-footer">
            <button id="moodleCollisionRetryWithCSVBtn" class="btn btn-primary">Check Again After Changes</button>
                <button id="moodleCollisionOkBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="ambiguityModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resolve File Conflicts</h5>
                <button type="button" class="btn-close ambiguity-close" aria-label="Close"></button>
            </div>
            <div class="modal-body">
        <p>Multiple suitable files found. Please select one file for each folder:</p>
        <div id="ambiguityProgress" style="margin-bottom: 15px; font-style: italic;"></div>
        <div id="ambiguityList"></div> 
                <div id="ambiguityError" class="error-message"></div>
            </div>
            <div class="modal-footer ambiguity-navigation">
                <button id="ambiguityPrevBtn" class="btn btn-secondary" disabled>&laquo; Previous</button>
                <button id="ambiguityNextBtn" class="btn btn-primary">Next &raquo;</button>
                <button id="confirmAmbiguityBtn" class="btn btn-success" style="display: none;">Confirm Selections</button> <!-- Initially hidden -->
            </div>
        </div>
    </div>
</div>

    <!-- UPDATED COVER TEMPLATE MODAL -->
    <div id="coverTemplateModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
                <div class="modal-header bg-light border-bottom p-3">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text text-primary me-2"></i>Edit Cover Template
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="form-group mb-3">
                        <label for="coverTemplateContentInput" class="form-label fw-bold">Template Content (Markdown):</label>
                        <textarea id="coverTemplateContentInput" class="form-control font-monospace" rows="20" style="height: 60vh;"></textarea>
        </div>
        
                    <!-- Template Help - Using Collapse Button -->
                    <div class="pattern-help">
                        <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#coverHelpCollapse">
                            <i class="bi bi-info-circle me-1"></i>Template Help & Placeholders
                        </button>
                        <div class="collapse mt-2" id="coverHelpCollapse">
                            <div class="card card-body bg-light py-2 small">
                                <p class="mb-2">Use Markdown to format the cover page. The following placeholders will be replaced:</p>
                                <ul class="ps-3 mb-2">
                        <li><code>{{FULL_NAME}}</code>: Student's full name (derived from folder name based on pattern).</li>
                        <li><code>{{LAST_NAME}}</code>: Student's last name.</li>
                        <li><code>{{FIRST_NAME}}</code>: Student's first name.</li>
                                    <li><code>{{STUDENTNUMBER}}</code>: Student's number (if available).</li>
                                    <li><code>{{SUBMITTED_PAGES_LIST}}</code>: List of submitted pages/filenames.</li>
                                    <li><code>{{MISSING_PAGES_LIST}}</code>: List of expected pages not found.</li>
                    </ul>
                                <p class="mb-1"><strong>Minimalistic Example:</strong></p>
                                <pre class="border bg-white p-2 rounded mb-0"><code># Booklet

**Student:** {{LAST_NAME}}, {{FIRST_NAME}}
**Student Number:** {{STUDENTNUMBER}}

## Submitted Pages:
{{SUBMITTED_PAGES_LIST}}

## Missing Pages:
{{MISSING_PAGES_LIST}}</code></pre>
                </div>
        </div>
    </div>
</div>
                <div class="modal-footer bg-light border-top p-3">
                    <span class="text-muted small me-auto">Changes are saved automatically when closing the modal.</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Includes -->
    <script src="src/js/renderer.js"></script>
    <script src="node_modules/flatpickr/dist/flatpickr.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="src/assets/vertical-calendar.js"></script>
    <script src="src/assets/vertical-calendar-controller.js"></script>
    <script src="src/assets/calendar-fix.js"></script>
    <script src="src/assets/app-switcher.js"></script>
    <script src="src/assets/batch-creator.js"></script>

    <!-- Initialization Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize tooltips and popovers
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize AppSwitcher
            window.appSwitcher = new AppSwitcher({
                mainViewSelector: '#main-view',
                mbzViewSelector: '#mbz-creator-view',
                switchButtonSelector: '#app-mode-switch', 
                titleElementSelector: '#main-header .app-title', // Target title within main header
                mainViewTitle: 'Booklet Generation Mode',
                mbzViewTitle: 'Moodle Batch Assignment Creation Mode'
            });

            let mbzCreatorInstance = null;
            let calendarControllerInstance = null;

            // Initialize MBZ creator only when its view becomes active
            window.addEventListener('viewChanged', async (event) => {
                if (event.detail.view === 'mbz' && !mbzCreatorInstance) {
                    const mbzContainer = document.getElementById('mbz-creator-view');
                    if (mbzContainer) {
                        mbzCreatorInstance = MbzBatchCreator.initialize(mbzContainer); // initialize returns the instance
                        // The buildUI method is now async, wait for it if necessary
                        await mbzCreatorInstance.buildUI(); 
                        // Re-find elements and attach listeners *after* UI is built
                        mbzCreatorInstance.findElements(); 
                        mbzCreatorInstance.setupCollapse(); // Setup collapse after elements are found
                        mbzCreatorInstance.initCalendar();
                        mbzCreatorInstance.attachEventListeners();
                        mbzCreatorInstance.updateGenerateButtonState();
                        
                        // Initialize calendar controller after MBZ UI and calendar are ready
                        setTimeout(() => { 
                            if (mbzCreatorInstance.calendar) {
                                // Pass the mbzCreatorInstance to the controller's initialize method
                                calendarControllerInstance = VerticalCalendarController.initialize(
                                    mbzCreatorInstance.calendar, 
                                    mbzCreatorInstance 
                                );
                                // Link the controller with the batch creator (optional if not used elsewhere)
                                mbzCreatorInstance.setController(calendarControllerInstance);
                            }
                        }, 100); // Short delay might be needed for calendar rendering
                    }
                }
            });

            // Handle initial view based on hash
            if (window.location.hash === '#mbz') {
                window.appSwitcher.showMbzView();
            }
            
            // Initialize modal functionality (if modal.js is removed)
            function initializeModals() {
                // Set up modal events for auto-saving config only (no focus management)
                ['settingsModal', 'coverTemplateModal'].forEach(modalId => {
                    const modalEl = document.getElementById(modalId);
                    if (modalEl) {
                        modalEl.addEventListener('hidden.bs.modal', () => {
                            console.log(`[DEBUG] ${modalId}: Modal hidden event, saving config`);
                            if (typeof window.saveConfig === 'function') {
                                window.saveConfig();
                            }
                        });
                    }
                });
                
                // Convert legacy modals to bootstrap modals if needed
                document.querySelectorAll('.modal:not(.fade)').forEach(modalEl => {
                    console.log(`[DEBUG] Converting legacy modal to Bootstrap: ${modalEl.id}`);
                    modalEl.classList.add('fade');
                });
                
                // Make main container focusable as fallback focus target
                const mainView = document.getElementById('main-view');
                if (mainView && !mainView.hasAttribute('tabindex')) {
                    mainView.setAttribute('tabindex', '-1');
                }
            }
            initializeModals();

            document.addEventListener('hide.bs.modal', function (event) {
                event.target.setAttribute('inert', '');
            });
            document.addEventListener('hidden.bs.modal', function (event) {
                event.target.removeAttribute('inert');
            });
        });
    </script>

</body>
</html>